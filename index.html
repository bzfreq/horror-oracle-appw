<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Horror Oracle</title>
  <link href="https://fonts.googleapis.com/css2?family=Creepster&family=Roboto:wght@300;400;500;700&family=Nosifer&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg-color: #0a0a0a;
      --text-color: #e0e0e0;
      --accent-color: #b91c1c;
      --secondary-color: #7d1414;
      --input-bg: #1a1a1a;
      --chat-bg: #111111;
      --user-bubble: #333;
      --bot-bubble: #222;
      --blood-color: #7d0b0b;
    }
    body {
      font-family: 'Roboto', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background-image: linear-gradient(to bottom, #200122, #060107);
    }
    .chat-window { background: var(--chat-bg); border: 1px solid #333; border-radius: 12px; }
    .chat-history { flex: 1; padding: 1rem; overflow-y: auto; scroll-behavior: smooth; }
    .chat-bubble { max-width: 80%; padding: 0.75rem; border-radius: 1rem; margin-bottom: 1rem; }
    .user-bubble { background: var(--user-bubble); align-self: flex-end; margin-left: auto; }
    .bot-bubble { background: var(--bot-bubble); align-self: flex-start; }
    .recommendations-panel { background: #1a1a1a; border-left: 2px solid #b91c1c; padding: 1rem; }
    .recommendation-bubble { background: #2a2a2a; border-radius: 0.5rem; padding: 0.5rem; margin-top: 0.25rem; }
    .fact-bubble { display: inline-block; background: #7d0b0b; color: white; border-radius: 0.5rem; padding: 0.4rem 0.7rem; margin: 0.2rem; cursor: pointer; }
    .poster { max-width: 200px; margin-top: 0.5rem; border-radius: 6px; }
    .buy-link { display: block; margin-top: 0.5rem; color: #ff4747; font-weight: bold; text-decoration: underline; }
    .blood-drop, .blood-splatter { position: fixed; background-color: var(--blood-color); pointer-events: none; z-index: 100; }
    .flicker { animation: flicker 0.1s infinite alternate; }
    @keyframes flicker { from {opacity: 1;} to {opacity: 0.7;} }
  </style>
</head>
<body>
  <div class="flex flex-row w-full h-screen">
    <div class="flex-1 flex flex-col">
      <header class="w-full flex justify-between items-center p-4">
        <h1 class="nosifer text-4xl text-white logo-glow">Horror Oracle</h1>
      </header>

      <main class="chat-window flex flex-col flex-1">
        <div id="chat-history" class="chat-history">
          <div class="bot-bubble">
            <p><strong>Horror Oracle:</strong> Greetings, mortal. Ask me of your nightmaresâ€¦</p>
          </div>
        </div>
        <div class="chat-input-area flex p-3">
          <input type="text" id="user-input" placeholder="Type a movie, director, or subgenre..."
            class="flex-1 px-4 py-3 rounded-full bg-gray-800 text-white placeholder-gray-500">
          <button id="send-btn" class="ml-2 px-6 py-3 bg-red-600 text-white rounded-full font-bold hover:bg-red-700">Send</button>
        </div>
      </main>
    </div>

    <!-- Side panel for Recommendations -->
    <aside class="recommendations-panel w-64">
      <h2 class="text-xl font-bold mb-2">ðŸ’€ Recommended Movies</h2>
      <div id="recommendations"></div>
    </aside>
  </div>

  <script>
    const chatHistory = document.getElementById('chat-history');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const recommendationsPanel = document.getElementById('recommendations');

    function appendMessage(sender, text, html = false) {
      const bubble = document.createElement('div');
      bubble.className = `chat-bubble ${sender === 'user' ? 'user-bubble' : 'bot-bubble'}`;
      bubble.innerHTML = html ? text : `<p>${text}</p>`;
      chatHistory.appendChild(bubble);
      chatHistory.scrollTop = chatHistory.scrollHeight; // auto-scroll
    }

    function appendRecommendationBubble(list) {
      const bubble = document.createElement('div');
      bubble.className = 'chat-bubble bot-bubble';
      bubble.innerHTML = "<strong>Recommended Movies:</strong><ul>" + list.map(r => `<li>${r.title} (${r.year})</li>`).join('') + "</ul>";
      chatHistory.appendChild(bubble);
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function appendFactBubbles(facts) {
      const bubble = document.createElement('div');
      bubble.className = 'chat-bubble bot-bubble';
      bubble.innerHTML = "<strong>Did you know?</strong><br>";
      facts.forEach(fact => {
        const span = document.createElement('span');
        span.className = 'fact-bubble';
        span.textContent = fact.label;
        span.onclick = () => appendMessage('bot', fact.text);
        bubble.appendChild(span);
      });
      chatHistory.appendChild(bubble);
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    async function sendMessage() {
      const query = userInput.value.trim();
      if (!query) return;
      appendMessage('user', query);
      userInput.value = '';

      try {
        const response = await fetch("/ask-oracle", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query })
        });
        const data = await response.json();

        // Build main oracle reply
        let oracleText = `<strong>${data.movie_title || query}</strong>`;
        if (data.year) oracleText += ` (${data.year})`;
        if (data.director) oracleText += ` â€” Directed by ${data.director}`;
        oracleText += `<br>${data.summary || "The Oracle sees nothing..."}`;

        // Poster + buy link
        if (data.poster_url) {
          oracleText += `<br><img src="${data.poster_url}" alt="Poster" class="poster">`;
          oracleText += `<a href="https://www.amazon.com/s?k=${encodeURIComponent(data.movie_title || query)}+dvd" target="_blank" class="buy-link">ðŸ›’ Buy this movie</a>`;
        }

        // Conversational hook
        oracleText += `<br><em>Do you want to know more about this film?</em>`;

        appendMessage('bot', oracleText, true);

        // Recommendations separate
        if (data.recommendations && data.recommendations.length) {
          appendRecommendationBubble(data.recommendations);

          // Update side panel
          recommendationsPanel.innerHTML = "";
          data.recommendations.forEach(r => {
            const recDiv = document.createElement('div');
            recDiv.className = 'recommendation-bubble';
            recDiv.textContent = `${r.title} (${r.year})`;
            recommendationsPanel.appendChild(recDiv);
          });
        }

        // Fact bubbles
        if (data.fun_facts && data.fun_facts.length) {
          appendFactBubbles(data.fun_facts);
        }

        triggerHorrorEffects();
      } catch (err) {
        appendMessage('bot', "âš ï¸ Oracle error: " + err.message);
      }
    }

    function createBloodDrop() {
      const d = document.createElement("div");
      d.classList.add("blood-drop");
      d.style.left = Math.random()*100 + "vw";
      document.body.appendChild(d);
      setTimeout(() => d.remove(), 2000);
    }
    function createBloodSplatter() {
      const s = document.createElement("div");
      s.classList.add("blood-splatter");
      s.style.left = Math.random()*100 + "vw";
      s.style.top = Math.random()*100 + "vh";
      document.body.appendChild(s);
      setTimeout(() => s.remove(), 1000);
    }
    function triggerFlicker() {
      document.body.classList.add("flicker");
      setTimeout(() => document.body.classList.remove("flicker"), 100);
    }
    function triggerHorrorEffects() {
      for (let i=0;i<5;i++) setTimeout(() => createBloodDrop(), i*200);
      for (let i=0;i<2;i++) setTimeout(() => createBloodSplatter(), i*500);
      triggerFlicker(); setTimeout(triggerFlicker,300); setTimeout(triggerFlicker,1200);
    }

    sendBtn.addEventListener("click", sendMessage);
    userInput.addEventListener("keydown", e => { if (e.key==="Enter") sendMessage(); });
  </script>
</body>
</html>
