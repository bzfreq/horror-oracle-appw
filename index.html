<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Horror Oracle</title>
  <link href="https://fonts.googleapis.com/css2?family=Creepster&family=Roboto:wght@300;400;500;700&family=Nosifer&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg-color: #0a0a0a;
      --text-color: #e0e0e0;
      --accent-color: #b91c1c;
      --secondary-color: #7d1414;
      --input-bg: #1a1a1a;
      --chat-bg: #111111;
      --user-bubble: #333;
      --bot-bubble: #222;
      --blood-color: #7d0b0b;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background-image: linear-gradient(to bottom, #200122, #060107);
    }

    .creepster { font-family: 'Creepster', cursive; }
    .nosifer { font-family: 'Nosifer', cursive; }

    .container {
      display: flex;
      flex: 1;
      padding: 1rem;
      gap: 2rem;
    }

    .side-panel {
      width: 250px;
      background: rgba(17, 17, 17, 0.7);
      border: 1px solid #333;
      border-radius: 12px;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      max-height: calc(100vh - 100px);
      overflow-y: auto;
    }

    .side-panel-title {
      color: var(--accent-color);
      font-weight: bold;
      text-transform: uppercase;
      text-align: center;
      margin-bottom: 10px;
    }

    .chat-window {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--chat-bg);
      border: 1px solid #333;
      border-radius: 12px;
      overflow: hidden;
    }

    .chat-history {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
      scroll-behavior: smooth;
    }

    .chat-input-area {
      padding: 1rem;
      background: var(--chat-bg);
      border-top: 1px solid #333;
      display: flex;
      gap: 0.5rem;
    }

    .chat-bubble {
      max-width: 80%;
      padding: 0.75rem;
      border-radius: 1rem;
      margin-bottom: 1rem;
    }

    .user-bubble {
      background: var(--user-bubble);
      align-self: flex-end;
      margin-left: auto;
    }

    .bot-bubble {
      background: var(--bot-bubble);
      align-self: flex-start;
    }

    .rec-card {
      background: rgba(40, 40, 40, 0.5);
      border: 1px solid #444;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 10px;
      padding: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .rec-card:hover {
      border-color: var(--accent-color);
    }

    .rec-card img {
      width: 40px;
      height: 60px;
      border-radius: 4px;
    }

    @media (max-width: 768px) {
      .container { flex-direction: column; }
      .side-panel { width: 100%; max-height: 200px; }
      .chat-window { height: 60vh; }
    }
  </style>
</head>
<body>
  <div class="centered-container mx-auto">
    <header class="w-full flex justify-between items-center p-4">
      <h1 class="nosifer text-4xl text-white">Horror Oracle</h1>
    </header>

    <div class="container">
      <!-- Recommendations Panel -->
      <aside class="side-panel">
        <h2 class="side-panel-title">Recommended Movies</h2>
        <div id="recommendations-container">
          <p class="text-gray-400 text-sm">Search for a movie to see recommendations</p>
        </div>
      </aside>

      <!-- Chat Window -->
      <main class="chat-window">
        <div id="chat-history" class="chat-history">
          <div class="bot-bubble text-sm">
            <p class="font-bold text-gray-400">Horror Oracle</p>
            <p>Greetings, mortal. What dark knowledge do you seek today?</p>
          </div>
        </div>
        <div class="chat-input-area">
          <input type="text" id="user-input" placeholder="Type a movie, director, or subgenre..." class="flex-1 px-4 py-3 rounded-full bg-gray-800 text-white">
          <button id="send-btn" class="px-6 py-3 bg-red-600 text-white rounded-full font-bold hover:bg-red-700">Send</button>
        </div>
      </main>
    </div>
  </div>

  <script>
    const chatHistory = document.getElementById('chat-history');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const recContainer = document.getElementById('recommendations-container');

    function appendMessage(sender, text, posterUrl=null, buyLink=null, fact=null) {
      const bubble = document.createElement('div');
      bubble.className = `chat-bubble ${sender === 'user' ? 'user-bubble' : 'bot-bubble'}`;
      bubble.innerHTML = `<p>${text}</p>`;

      if (posterUrl) {
        const img = document.createElement('img');
        img.src = posterUrl;
        img.alt = "Movie Poster";
        img.className = "mt-2 rounded";
        bubble.appendChild(img);
      }

      if (buyLink) {
        const link = document.createElement('a');
        link.href = buyLink;
        link.target = "_blank";
        link.className = "block mt-2 text-blue-400 underline";
        link.textContent = "Buy this movie";
        bubble.appendChild(link);
      }

      if (fact) {
        const factBtn = document.createElement('button');
        factBtn.textContent = "Did you know?";
        factBtn.className = "mt-2 px-3 py-1 text-xs bg-red-600 text-white rounded-full hover:bg-red-700";
        factBtn.onclick = () => {
          appendMessage('bot', fact);
        };
        bubble.appendChild(factBtn);
      }

      chatHistory.appendChild(bubble);
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    async function sendMessage() {
      const query = userInput.value.trim();
      if (!query) return;
      appendMessage('user', query);
      userInput.value = '';

      try {
        const response = await fetch('/ask-oracle', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query })
        });

        const data = await response.json();
        appendMessage('bot', data.summary || "The Oracle is silent...", data.poster_url, data.amazon_link, data.interesting_fact);

        // Show recommendations in sidebar
        recContainer.innerHTML = '';
        if (data.recommendations && data.recommendations.length > 0) {
          data.recommendations.forEach(rec => {
            const card = document.createElement('div');
            card.className = "rec-card";
            card.innerHTML = `
              <img src="${rec.poster_url || 'https://placehold.co/40x60'}" alt="">
              <div>
                <div class="text-sm font-bold">${rec.title}</div>
                <div class="text-xs text-gray-400">${rec.year || ''}</div>
              </div>
            `;
            card.onclick = () => {
              userInput.value = rec.title;
              sendMessage();
            };
            recContainer.appendChild(card);
          });
        } else {
          recContainer.innerHTML = '<p class="text-gray-400 text-sm">No recommendations found</p>';
        }
      } catch (err) {
        appendMessage('bot', "Dark forces block my vision. Try again later.");
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
      }
    });
  </script>
</body>
</html>
